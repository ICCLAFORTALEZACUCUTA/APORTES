<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Acad√©mica - Pagos y Notas</title>
    <style>
        /* Estilos B√°sicos */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f7f6;
    color: #333;
}

header {
    background-color: #007bff;
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

h1 {
    margin: 0;
    font-size: 1.5rem;
}

main {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.view {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
}

/* Formularios y Entradas */
form input[type="text"], 
form input[type="password"], 
form select,
form textarea,
#search-participante {
    width: 100%;
    padding: 10px;
    margin: 8px 0 16px 0;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}

button {
    background-color: #007bff;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #0056b3;
}

.error-text {
    color: red;
    font-weight: bold;
}

/* Tabs */
.tabs {
    display: flex;
    margin-bottom: 20px;
    border-bottom: 2px solid #ddd;
}

.tab-button {
    background-color: #f1f1f1;
    color: #333;
    padding: 10px 15px;
    cursor: pointer;
    border: none;
    border-radius: 5px 5px 0 0;
    margin-right: 5px;
    transition: background-color 0.3s;
}

.tab-button.active {
    background-color: white;
    border: 2px solid #ddd;
    border-bottom: 2px solid white;
}

.tab-content {
    padding: 10px 0;
}

/* Tablas */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

table th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.deuda-pendiente {
    color: #dc3545;
    font-size: 1.2em;
}

/* Responsividad */
@media (max-width: 600px) {
    header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .view {
        padding: 10px;
    }
    
    .tabs {
        flex-direction: column;
    }
    
    .tab-button {
        width: 100%;
        margin-bottom: 5px;
    }

    /* Ocultar algunas columnas en m√≥viles */
    #participantes-table th:nth-child(3), 
    #participantes-table td:nth-child(3) {
        display: none; 
    }
}

/* Estilos de Meses (para el formulario de pago) */
#meses-pendientes-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin-bottom: 15px;
}

.mes-item {
    padding: 5px 10px;
    border: 1px solid #007bff;
    border-radius: 4px;
    background-color: #e9f7ff;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s, border-color 0.2s;
}

.mes-item.selected {
    background-color: #007bff;
    color: white;
    border-color: #0056b3;
}

/* Estilos de Modales */
.modal {
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4); 
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto; 
    padding: 20px;
    border: 1px solid #888;
    width: 80%; 
    max-width: 500px;
    border-radius: 8px;
    position: relative;
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close-button:hover,
.close-button:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
    </style>
</head>
<body>
    <header>
        <h1>Sistema de Gesti√≥n</h1>
        <button id="logout-btn" style="display: none;">Cerrar Sesi√≥n</button>
    </header>
    
    <main id="app-container">
        <section id="login-view" class="view active">
            <h2>Acceso al Sistema</h2>
            <form id="login-form">
                <input type="text" id="usuario" placeholder="Usuario/C√≥digo" required>
                <input type="password" id="contrasena" placeholder="Contrase√±a" required>
                <button type="submit">Ingresar</button>
                <p id="login-message" class="error-text"></p>
            </form>
        </section>

        <section id="admin-dashboard-view" class="view" style="display: none;">
            <h2>Dashboard Administrativo üìä</h2>
            <nav class="tabs">
                <button class="tab-button active" data-tab="gestion-participantes">Participantes</button>
                <button class="tab-button" data-tab="gestion-notas">Notas</button>
                <button class="tab-button" data-tab="registro-pagos">Registro Pagos</button>
            </nav>
            
            <div id="gestion-participantes" class="tab-content active">
                <h3>Listado de Participantes</h3>
                <input type="text" id="search-participante" placeholder="Buscar por Nombre/C√≥digo">
                <table id="participantes-table">
                    <thead>
                        <tr><th>C√≥digo</th><th>Participante</th><th>Deuda ($)</th><th>Ver Detalle</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div id="gestion-notas" class="tab-content">
                <h3>Gesti√≥n de Notas (Incidencias)</h3>
                <button id="show-crear-nota">Crear Nueva Nota</button>
                <table id="notas-table">
                    <thead>
                        <tr><th>ID</th><th>Participante</th><th>Situaci√≥n</th><th>Estado</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div id="registro-pagos" class="tab-content">
                <h3>Registro de Pagos</h3>
                <form id="pago-form">
                    <input type="text" id="pago-codigo" placeholder="C√≥digo Participante" required>
                    <div id="meses-pendientes-container">
                        </div>
                    <p>Deuda a pagar (seleccionada): <span id="monto-a-pagar">$0</span></p>
                    <button type="submit">Registrar Pago</button>
                    <p id="pago-message" class="error-text"></p>
                </form>
            </div>
        </section>

        <section id="detalle-view" class="view" style="display: none;">
            <button id="back-to-dashboard">‚Üê Volver</button>
            <h2 id="detalle-nombre">Detalle de: [Nombre]</h2>
            <p><strong>C√≥digo:</strong> <span id="detalle-codigo"></span></p>
            <p><strong>URL para Padre:</strong> <span id="detalle-url-padre"></span> <button onclick="copyUrl()">Copiar URL</button></p>
            
            <div class="summary-box">
                <p>Deuda Pendiente: <strong id="detalle-deuda-total" class="deuda-pendiente"></strong></p>
                <p>Meses Pendientes: <span id="detalle-meses-pendientes"></span></p>
            </div>
            
            <h3>Historial de Pagos</h3>
            <table id="historial-pagos-table">
                <thead><tr><th>ID Pago</th><th>Meses</th><th>Monto</th><th>Fecha</th></tr></thead>
                <tbody></tbody>
            </table>
            
            <h3>Notas Creadas</h3>
            <table id="historial-notas-table">
                <thead><tr><th>ID Nota</th><th>Situaci√≥n</th><th>Estado</th><th>Soluci√≥n</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
        
        <div id="nota-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('nota-modal').style.display='none'">&times;</span>
                <h3>Crear Nueva Nota</h3>
                <form id="crear-nota-form">
                    <select id="nota-participante" required>
                        </select>
                    <textarea id="nota-situacion" placeholder="Describa la situaci√≥n/incidencia" rows="4" required></textarea>
                    <button type="submit">Guardar Nota</button>
                    <p id="nota-message" class="error-text"></p>
                </form>
            </div>
        </div>

        <div id="solucion-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button" onclick="document.getElementById('solucion-modal').style.display='none'">&times;</span>
                <h3 id="solucion-titulo">Solucionar Nota #</h3>
                <p>Situaci√≥n: <strong id="solucion-situacion"></strong></p>
                <form id="cerrar-nota-form">
                    <input type="hidden" id="cerrar-nota-id">
                    <textarea id="cerrar-nota-solucion" placeholder="Describa la soluci√≥n aplicada" rows="4" required></textarea>
                    <button type="submit">Cerrar Nota</button>
                    <p id="solucion-message" class="error-text"></p>
                </form>
            </div>
        </div>
        
    </main>

    <script>
        // ** Importante: Reemplaza esta URL con la URL de tu Despliegue de Apps Script **
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjpjLxF793t7qSbAak9haJkAVdoLfUy9HbauNFtEWspnDoWDqznYvslRBiB-He85El/exec'; 

let CURRENT_USER = null; // Almacenar√° { rol, codigo, url_id }

// ====================================================================
// UTILIDADES Y COMUNICACI√ìN CON APPS SCRIPT
// ====================================================================

/**
 * Funci√≥n para enviar peticiones POST al Apps Script.
 * @param {string} action - La acci√≥n que el backend debe ejecutar.
 * @param {object} data - Datos a enviar.
 * @returns {Promise<object>}
 */
async function callBackend(action, data = {}) {
    const payload = { action, data };
    
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'cors', // Necesario para llamadas entre dominios (GitHub Pages a Google)
            headers: {
                'Content-Type': 'text/plain', // Apps Script a menudo requiere 'text/plain' para el JSON
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        // Apps Script devuelve un Content-Type: text/html, por lo que usamos response.text()
        const text = await response.text();
        return JSON.parse(text);

    } catch (error) {
        console.error('Error al llamar al backend:', error);
        return { success: false, message: 'Fallo de conexi√≥n con el servidor.' };
    }
}

/**
 * Funci√≥n para cambiar la vista en la SPA (Single Page Application).
 * @param {string} viewId - ID de la secci√≥n a mostrar (ej: 'login-view').
 */
function showView(viewId) {
    document.querySelectorAll('.view').forEach(view => {
        view.style.display = 'none';
        view.classList.remove('active');
    });
    const targetView = document.getElementById(viewId);
    if (targetView) {
        targetView.style.display = 'block';
        targetView.classList.add('active');
        // Limpiar mensajes de error al cambiar de vista
        document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
    }
    // Mostrar/ocultar bot√≥n de cerrar sesi√≥n
    document.getElementById('logout-btn').style.display = (viewId !== 'login-view' ? 'block' : 'none');
}

// ====================================================================
// VISTA DE LOGIN Y SESI√ìN
// ====================================================================

document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const usuario = document.getElementById('usuario').value.trim();
    const contrasena = document.getElementById('contrasena').value;
    const msgEl = document.getElementById('login-message');
    msgEl.textContent = 'Iniciando sesi√≥n...';

    const result = await callBackend('LOGIN', { usuario, contrasena });

    if (result.success) {
        CURRENT_USER = result;
        localStorage.setItem('currentUser', JSON.stringify(CURRENT_USER)); // Guardar sesi√≥n
        msgEl.textContent = '√âxito. Redirigiendo...';
        
        // Manejo de roles
        if (CURRENT_USER.rol === 'Administrador' || CURRENT_USER.rol === 'Profesor') {
            initAdminDashboard();
            showView('admin-dashboard-view');
        } else if (CURRENT_USER.rol === 'Padre') {
            loadDetalleParticipante(CURRENT_USER.codigo);
            showView('detalle-view');
        }
    } else {
        msgEl.textContent = result.message || 'Error de autenticaci√≥n.';
        CURRENT_USER = null;
    }
});

document.getElementById('logout-btn').addEventListener('click', () => {
    CURRENT_USER = null;
    localStorage.removeItem('currentUser');
    showView('login-view');
});

// Inicializaci√≥n al cargar la p√°gina (manejo de URL para padres o sesi√≥n guardada)
window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const urlId = params.get('id');

    if (urlId) {
        // L√≥gica de URL p√∫blica para padre (simula un login de tipo "Padre")
        CURRENT_USER = { rol: 'Padre', codigo: urlId, url_id: urlId }; // Usamos el ID como c√≥digo temporal
        loadDetalleParticipante(urlId);
        showView('detalle-view');
    } else {
        // Cargar sesi√≥n guardada si existe
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            CURRENT_USER = JSON.parse(storedUser);
            if (CURRENT_USER.rol === 'Administrador' || CURRENT_USER.rol === 'Profesor') {
                initAdminDashboard();
                showView('admin-dashboard-view');
            } else if (CURRENT_USER.rol === 'Padre') {
                loadDetalleParticipante(CURRENT_USER.codigo);
                showView('detalle-view');
            } else {
                showView('login-view');
            }
        } else {
            showView('login-view');
        }
    }
};

// ====================================================================
// DASHBOARD Y GESTI√ìN ADMINISTRATIVA
// ====================================================================

let dashboardInterval = null;
let allParticipantes = []; // Cache para la b√∫squeda

function initAdminDashboard() {
    // 1. Cargar datos iniciales
    loadDashboardData();
    
    // 2. Establecer el refresco de 5 segundos
    if (dashboardInterval) clearInterval(dashboardInterval); // Limpia si ya existe
    dashboardInterval = setInterval(loadDashboardData, 5000); // ** Refresco cada 5 segundos **

    // 3. Manejo de pesta√±as
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById(this.dataset.tab).classList.add('active');
        });
    });

    // 4. B√∫squeda de participantes
    document.getElementById('search-participante').addEventListener('input', filterParticipantes);
}

// Funci√≥n para el refresco as√≠ncrono
async function loadDashboardData() {
    console.log('Refrescando datos del dashboard...');
    const result = await callBackend('GET_DASHBOARD_DATA', { rol: CURRENT_USER.rol });

    if (result.success) {
        allParticipantes = result.participantes;
        
        // Actualizar Participantes
        renderParticipantesTable(allParticipantes);
        
        // Actualizar Notas (solo si la pesta√±a est√° activa o lo necesitamos)
        if (document.getElementById('gestion-notas').classList.contains('active')) {
             renderNotasTable(result.notas);
        }
        
        // Cargar select de crear nota
        renderParticipanteSelect(allParticipantes);
        
    } else {
        console.error('Fallo al cargar dashboard:', result.message);
    }
}

function filterParticipantes(e) {
    const filtro = e.target.value.toLowerCase();
    const filtered = allParticipantes.filter(p => 
        p.nombre.toLowerCase().includes(filtro) || 
        p.codigo.toLowerCase().includes(filtro)
    );
    renderParticipantesTable(filtered);
}

// Dibuja la tabla de participantes (Admin View)
function renderParticipantesTable(data) {
    const tbody = document.getElementById('participantes-table').querySelector('tbody');
    tbody.innerHTML = '';

    data.forEach(p => {
        const row = tbody.insertRow();
        row.insertCell().textContent = p.codigo;
        row.insertCell().textContent = p.nombre;
        row.insertCell().textContent = `$${p.deudaTotal.toLocaleString()}`;
        
        const actionCell = row.insertCell();
        const detailBtn = document.createElement('button');
        detailBtn.textContent = 'Detalle';
        detailBtn.onclick = () => {
            clearInterval(dashboardInterval); // Detiene el refresco al ver detalle
            loadDetalleParticipante(p.codigo);
            showView('detalle-view');
        };
        actionCell.appendChild(detailBtn);
    });
}

// Dibuja la tabla de notas (Admin View)
function renderNotasTable(data) {
    const tbody = document.getElementById('notas-table').querySelector('tbody');
    tbody.innerHTML = '';

    data.forEach(n => {
        const row = tbody.insertRow();
        row.insertCell().textContent = n.id;
        row.insertCell().textContent = n.participante;
        row.insertCell().textContent = n.situacion.substring(0, 50) + '...';
        
        const estadoCell = row.insertCell();
        estadoCell.textContent = n.estado;
        estadoCell.style.fontWeight = 'bold';
        estadoCell.style.color = n.estado === 'ABIERTA' ? 'red' : 'green';
        
        const actionCell = row.insertCell();
        const actionBtn = document.createElement('button');
        actionBtn.textContent = n.estado === 'ABIERTA' ? 'Solucionar' : 'Ver Soluci√≥n';
        actionBtn.onclick = () => openSolucionModal(n);
        actionCell.appendChild(actionBtn);
    });
}

// Carga el Select para la creaci√≥n de notas
function renderParticipanteSelect(participantes) {
    const select = document.getElementById('nota-participante');
    select.innerHTML = '<option value="" disabled selected>Seleccione Participante</option>';
    participantes.forEach(p => {
        const option = document.createElement('option');
        option.value = p.nombre;
        option.textContent = `${p.nombre} (${p.codigo})`;
        select.appendChild(option);
    });
}

// ====================================================================
// GESTI√ìN DE NOTAS (Admin)
// ====================================================================

document.getElementById('show-crear-nota').addEventListener('click', () => {
    document.getElementById('nota-modal').style.display = 'block';
    document.getElementById('crear-nota-form').reset();
    document.getElementById('nota-message').textContent = '';
});

document.getElementById('crear-nota-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const participante = document.getElementById('nota-participante').value;
    const situacion = document.getElementById('nota-situacion').value;
    const msgEl = document.getElementById('nota-message');
    msgEl.textContent = 'Guardando nota...';

    const result = await callBackend('CREAR_NOTA', { participante, situacion });

    if (result.success) {
        msgEl.textContent = result.message;
        document.getElementById('crear-nota-form').reset();
        loadDashboardData(); // Refresca la tabla de notas
        setTimeout(() => {
            document.getElementById('nota-modal').style.display = 'none';
        }, 1500);
    } else {
        msgEl.textContent = result.message || 'Error al crear la nota.';
    }
});

function openSolucionModal(nota) {
    const modal = document.getElementById('solucion-modal');
    document.getElementById('solucion-titulo').textContent = `Solucionar Nota #${nota.id}`;
    document.getElementById('solucion-situacion').textContent = nota.situacion;
    document.getElementById('cerrar-nota-id').value = nota.id;
    document.getElementById('solucion-message').textContent = '';
    
    const solucionTextarea = document.getElementById('cerrar-nota-solucion');
    
    if (nota.estado === 'CERRADA') {
        solucionTextarea.value = nota.solucion;
        solucionTextarea.readOnly = true;
        document.querySelector('#cerrar-nota-form button[type="submit"]').style.display = 'none';
    } else {
        solucionTextarea.value = '';
        solucionTextarea.readOnly = false;
        document.querySelector('#cerrar-nota-form button[type="submit"]').style.display = 'block';
    }
    
    modal.style.display = 'block';
}

document.getElementById('cerrar-nota-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const id = parseInt(document.getElementById('cerrar-nota-id').value);
    const solucion = document.getElementById('cerrar-nota-solucion').value;
    const msgEl = document.getElementById('solucion-message');
    msgEl.textContent = 'Cerrando nota...';

    const result = await callBackend('CERRAR_NOTA', { id, solucion });

    if (result.success) {
        msgEl.textContent = result.message;
        loadDashboardData(); // Refresca la tabla de notas
        setTimeout(() => {
            document.getElementById('solucion-modal').style.display = 'none';
        }, 1500);
    } else {
        msgEl.textContent = result.message || 'Error al cerrar la nota.';
    }
});

// ====================================================================
// REGISTRO DE PAGOS (Admin)
// ====================================================================

// Alerta: Este es un formulario simple. La l√≥gica avanzada de tu VBA debe manejarse en GAS.
let mesesPendientesCache = []; // Cache de meses pendientes para la selecci√≥n de pagos

document.getElementById('pago-codigo').addEventListener('input', async (e) => {
    const codigo = e.target.value.trim().toUpperCase();
    const container = document.getElementById('meses-pendientes-container');
    container.innerHTML = 'Buscando...';
    document.getElementById('monto-a-pagar').textContent = '$0';
    mesesPendientesCache = [];

    if (codigo.length < 5) return;

    // Llama al detalle para obtener la lista de meses pendientes
    const result = await callBackend('GET_PARTICIPANTE_DETALLE', { codigo });

    container.innerHTML = '';
    if (result.success) {
        mesesPendientesCache = result.resumen_pago.mesesPendientes;
        if (mesesPendientesCache.length === 0) {
            container.textContent = 'No hay meses pendientes de pago.';
            return;
        }

        mesesPendientesCache.forEach(mes => {
            const item = document.createElement('div');
            item.className = 'mes-item';
            item.dataset.mes = mes;
            item.textContent = formatMes(mes); // Funci√≥n de formato (definida abajo)
            item.onclick = toggleMesSeleccionado;
            container.appendChild(item);
        });
    } else {
        container.textContent = 'Participante no encontrado o error.';
    }
});

function formatMes(codigoMes) {
    const anio = codigoMes.substring(0, 4);
    const mes = codigoMes.substring(4, 6);
    const nombres = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
    return `${nombres[parseInt(mes) - 1]} ${anio}`;
}

function toggleMesSeleccionado() {
    this.classList.toggle('selected');
    calculateMonto();
}

function calculateMonto() {
    let monto = 0;
    document.querySelectorAll('.mes-item.selected').forEach(item => {
        const mes = item.dataset.mes;
        // La l√≥gica de c√°lculo de precios est√° en el Apps Script.
        // Aqu√≠ podr√≠amos estimar, pero para simplificar, confiamos en el backend.
        // Usaremos un valor fijo o cachearemos el precio para cada mes para no llamar al backend
        // For simplicity: hardcoding the value based on your rules (GAS will do the real check)
        if (mes >= '202201' && mes <= '202406') monto += 2000;
        else if (mes >= '202407' && mes <= '202712') monto += 3000;
    });
    document.getElementById('monto-a-pagar').textContent = `$${monto.toLocaleString()}`;
}


document.getElementById('pago-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const codigo = document.getElementById('pago-codigo').value.trim().toUpperCase();
    const msgEl = document.getElementById('pago-message');
    const selectedMeses = Array.from(document.querySelectorAll('.mes-item.selected')).map(el => el.dataset.mes);

    if (selectedMeses.length === 0) {
        msgEl.textContent = 'Seleccione al menos un mes para registrar el pago.';
        return;
    }
    
    msgEl.textContent = 'Registrando pago...';

    const result = await callBackend('REGISTRAR_PAGO', { codigo, meses: selectedMeses });

    if (result.success) {
        msgEl.textContent = result.message;
        document.getElementById('pago-form').reset();
        document.getElementById('meses-pendientes-container').innerHTML = ''; // Limpiar meses
        document.getElementById('monto-a-pagar').textContent = '$0';
        loadDashboardData(); // Refresca dashboard
    } else {
        msgEl.textContent = result.message || 'Error al registrar el pago.';
    }
});

// ====================================================================
// VISTA DE DETALLE (PADRE O ADMIN)
// ====================================================================

document.getElementById('back-to-dashboard').addEventListener('click', () => {
    if (CURRENT_USER && (CURRENT_USER.rol === 'Administrador' || CURRENT_USER.rol === 'Profesor')) {
        initAdminDashboard();
        showView('admin-dashboard-view');
    } else {
        // Si el padre est√° viendo por URL, no hay dashboard, solo se regresa al login
        showView('login-view');
    }
});


async function loadDetalleParticipante(codigo) {
    const result = await callBackend('GET_PARTICIPANTE_DETALLE', { codigo });
    showView('detalle-view');
    
    if (result.success) {
        const p = result.participante;
        const resumen = result.resumen_pago;

        // Datos del participante
        document.getElementById('detalle-nombre').textContent = `Detalle de: ${p.nombre}`;
        document.getElementById('detalle-codigo').textContent = p.codigo;
        
        // URL del Padre (solo relevante si el admin la est√° viendo)
        const appUrlBase = window.location.href.split('?')[0];
        const urlPadreEl = document.getElementById('detalle-url-padre');
        
        if (CURRENT_USER.rol === 'Padre') {
            document.querySelector('#detalle-url-padre').parentNode.style.display = 'none';
        } else {
            document.querySelector('#detalle-url-padre').parentNode.style.display = 'block';
            urlPadreEl.textContent = `${appUrlBase}?id=${result.url_id}`;
        }
        
        // Resumen
        document.getElementById('detalle-deuda-total').textContent = `$${resumen.deudaTotal.toLocaleString()}`;
        document.getElementById('detalle-meses-pendientes').textContent = resumen.mesesPendientes.map(formatMes).join(' | ') || 'Ninguno.';

        // Historial de Pagos
        const pagosTbody = document.getElementById('historial-pagos-table').querySelector('tbody');
        pagosTbody.innerHTML = '';
        result.pagos.forEach(pago => {
            const row = pagosTbody.insertRow();
            row.insertCell().textContent = pago.id;
            row.insertCell().textContent = pago.meses.split(', ').map(formatMes).join(', ');
            row.insertCell().textContent = `$${pago.monto.toLocaleString()}`;
            row.insertCell().textContent = pago.fecha;
        });

        // Notas Creadas
        const notasTbody = document.getElementById('historial-notas-table').querySelector('tbody');
        notasTbody.innerHTML = '';
        result.notas.forEach(nota => {
            const row = notasTbody.insertRow();
            row.insertCell().textContent = nota.id;
            row.insertCell().textContent = nota.situacion;
            const estadoCell = row.insertCell();
            estadoCell.textContent = nota.estado;
            estadoCell.style.color = nota.estado === 'ABIERTA' ? 'red' : 'green';
            row.insertCell().textContent = nota.solucion || 'Pendiente';
        });

    } else {
        alert(result.message);
        showView('admin-dashboard-view');
    }
}

function copyUrl() {
    const urlText = document.getElementById('detalle-url-padre').textContent;
    navigator.clipboard.writeText(urlText).then(() => {
        alert('URL copiada al portapapeles.');
    }, (err) => {
        alert('Error al copiar URL.');
    });
}
    </script>
</body>
</html>
