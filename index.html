<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Aportes ONG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* Estilos base (Manejo de colores primarios) */
        :root { --color-primary: #10B981; } /* Green-500 */
        .bg-primary { background-color: var(--color-primary); }
        .text-primary { color: var(--color-primary); }
        .active-link { background-color: #374151; /* gray-700 */ } 
        /* Overlay de Carga */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"></div>
            <p id="loader-message" class="mt-4 text-lg text-gray-700 font-semibold">Cargando Sistema...</p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <div id="sidebar" class="w-64 fixed h-full bg-gray-800 text-white p-4 hidden lg:block transition-all duration-300">
            <h1 class="text-xl font-bold mb-8 text-primary">Sistema ONG Aportes</h1>
            <nav>
                <a href="#" data-module="dashboard" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 active-link">Dashboard</a>
                <a href="#" data-module="aportes" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 mt-2">Aportes & Registro</a>
                <a href="#" data-module="participantes" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 mt-2 admin-only">Participantes (CRUD)</a>
                <a href="#" data-module="actividad" class="block py-2 px-4 rounded transition duration-200 hover:bg-gray-700 mt-2 admin-only">Registro Actividad</a>
                </nav>
            <div class="absolute bottom-4 left-4">
                <p class="text-sm text-gray-400">Usuario: <span id="user-display" class="font-semibold"></span></p>
                <button onclick="logout()" class="text-sm text-red-400 hover:text-red-500 mt-1">Cerrar Sesión</button>
            </div>
        </div>
        
        <main class="lg:ml-64 p-8">
            <header class="mb-8 flex justify-between items-center">
                <h2 id="module-title" class="text-3xl font-bold text-gray-800"></h2>
            </header>

            <div id="dashboard-module" class="module-content"></div>
            <div id="aportes-module" class="module-content hidden"></div>
            <div id="participantes-module" class="module-content hidden admin-only">
                <p class="text-lg text-red-500">Funcionalidad CRUD omitida por extensión, pero aquí irían la tabla y el modal.</p>
            </div>
            <div id="actividad-module" class="module-content hidden admin-only"></div>

        </main>
    </div>

    <div id="login-container" class="flex flex-col items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-xl">
            <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Acceso al Sistema ONG</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Iniciar Sesión
                </button>
                <div id="login-message"></div>
            </form>
        </div>
    </div>

    <script>
        // =======================================================
        // === CONFIGURACIÓN Y VARIABLES GLOBALES (FRONTEND) ===
        // =======================================================
        // La URL es inyectada por Apps Script desde el archivo Code.gs
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbybWaKOW2qL25VOYe-gb4WMAl3l0xW-Gko2qY7ALnt8JfEo_nV6uwPX5F00ItXul4MQ/exec'; 
        const REFRESH_INTERVAL = 5000; // 5 segundos
        const ROL_ADMIN = 'ADMIN';

        let userData = {}; // { token, rol, tutoraID, usuario }
        let allParticipants = [];
        let allAportes = [];
        let globalStats = {};
        let refreshTimer = null;
        let activeModule = 'dashboard';
        let mainChartInstance = null;
        
        // =======================================================
        // === CONEXIÓN Y PROTOCOLO DE DATOS (HACKING REFRESH) ===
        // =======================================================

        async function sendToAppsScript(data, token = userData.token) {
            showLoader("Procesando Solicitud...");
            
            const payload = { ...data, token: token, rol: userData.rol, tutoraID: userData.tutoraID, registrador: userData.usuario };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const result = await response.json();
                hideLoader();
                
                if (result.status === "error") throw new Error(result.message);
                
                // Forzar un refresh silencioso después de modificar datos
                if (['registrarAporte', 'crudParticipante', 'borrarActividad'].includes(data.action)) {
                    await loadData(false); 
                }

                return result.data;

            } catch (error) {
                hideLoader();
                console.error("Error en sendToAppsScript:", error);
                throw error;
            }
        }

        async function loadData(mostrarProgreso = true) {
            if (mostrarProgreso) showLoader("Cargando Datos Iniciales...");
            else console.log(`[REFRESH SILENCIOSO] Ciclo a las ${new Date().toLocaleTimeString()}`);

            try {
                const data = await sendToAppsScript({ action: 'obtenerDatosIniciales' }, userData.token); 
                
                allParticipants = data.participantes;
                allAportes = data.aportes;
                globalStats = data.estadisticas;

                renderModule(activeModule);
                
                if (mostrarProgreso) showMessage('login-message', 'Carga de datos completa.', 'success');
                
            } catch (error) {
                if (mostrarProgreso) {
                    showMessage('login-message', `Error al cargar datos: ${error.message}.`, 'error');
                } else {
                    console.warn(`[REFRESH FALLIDO] Error: ${error.message}.`);
                }
                if (mostrarProgreso && error.message.includes('Sesión expirada')) logout();
            }
        }

        function setupAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => { loadData(false); }, REFRESH_INTERVAL); 
        }

        // --- LÓGICA DE INTERFAZ (UI/UX) ---

        function showLoader(message) {
            document.getElementById('loader-message').textContent = message;
            document.getElementById('loader-overlay').classList.remove('hidden');
        }

        function hideLoader() {
            document.getElementById('loader-overlay').classList.add('hidden');
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (!element) return;
            element.innerHTML = `<p class="text-sm text-center mt-2 p-2 rounded">${message}</p>`;
            if (type === 'success') element.querySelector('p').classList.add('bg-green-100', 'text-green-700');
            else if (type === 'error') element.querySelector('p').classList.add('bg-red-100', 'text-red-700');
            else element.querySelector('p').classList.add('bg-blue-100', 'text-blue-700');
            setTimeout(() => { element.innerHTML = ''; }, 8000);
        }

        function renderModule(moduleName) {
            activeModule = moduleName;
            document.querySelectorAll('.module-content').forEach(el => el.classList.add('hidden'));
            const moduleEl = document.getElementById(`${moduleName}-module`);
            moduleEl.classList.remove('hidden');
            document.getElementById('module-title').textContent = moduleName.toUpperCase().replace('-', ' Y ');
            
            document.querySelectorAll('#sidebar a').forEach(a => a.classList.remove('active-link'));
            document.querySelector(`#sidebar a[data-module="${moduleName}"]`).classList.add('active-link');

            if (moduleName === 'dashboard') renderDashboard(moduleEl);
            else if (moduleName === 'aportes') renderAportes(moduleEl);
            else if (moduleName === 'actividad') renderActividad(moduleEl);
        }
        
        // --- RENDERING DE MÓDULOS ---

        function renderDashboard(container) {
            if (userData.rol !== ROL_ADMIN) { container.innerHTML = '<p class="text-lg text-red-500">Acceso Denegado.</p>'; return; }
            const { totalRecibido, aportesPorMes, mediaAporte } = globalStats;
            
            const sortedMonths = Object.keys(aportesPorMes).sort((a, b) => {
                const [mA, aA] = a.split('/').map(Number);
                const [mB, aB] = b.split('/').map(Number);
                if (aA !== aB) return aA - aB; return mA - mB;
            });
            const chartData = {
                labels: sortedMonths,
                datasets: [{
                    label: 'Aportes Totales',
                    data: sortedMonths.map(month => aportesPorMes[month]),
                    backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: '#10B981', borderWidth: 1
                }]
            };

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <p class="text-sm font-medium text-gray-500">Total Recibido</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">$${(totalRecibido || 0).toLocaleString('es-CO')}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <p class="text-sm font-medium text-gray-500">Media de Aportes</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">$${(mediaAporte || 0).toLocaleString('es-CO', {maximumFractionDigits: 0})}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <p class="text-sm font-medium text-gray-500">Participantes Activos</p>
                        <p class="text-2xl font-bold text-gray-900 mt-1">${allParticipants.filter(p => p.estado === 'ACTIVO').length}</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow mb-8">
                    <h3 class="text-lg font-semibold mb-4">Aportes por Mes (Gráfica)</h3>
                    <canvas id="aportesChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-semibold mb-4">Últimos 10 Aportes Registrados</h3>
                    ${renderLastAportesTable(allAportes)}
                </div>
            `;
            const ctx = document.getElementById('aportesChart').getContext('2d');
            if (mainChartInstance) mainChartInstance.destroy();
            mainChartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
        }
        
        function renderLastAportesTable(aportes) {
            if (aportes.length === 0) return '<p class="text-gray-500">No hay aportes recientes.</p>';
            return `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cód. Part.</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mes Cubierto</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Pagado</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registrador</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th></tr></thead>
                <tbody class="bg-white divide-y divide-gray-200">${aportes.map(a => `
                    <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.codigoParticipante}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.mesCubierto}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">$${a.montoPagado.toLocaleString('es-CO')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.registrador}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(a.fechaRegistro).toLocaleDateString('es-CO')}</td></tr>`).join('')}</tbody></table></div>`;
        }
        
        function renderAportes(container) {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow h-fit">
                        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Registrar Nuevo Aporte</h3>
                        <div id="aporte-message" class="mb-4"></div>
                        
                        <label for="select-participante" class="block text-sm font-medium text-gray-700">Seleccionar Participante</label>
                        <select id="select-participante" onchange="loadParticipanteInfo()" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                            <option value="">-- Seleccione un participante --</option>
                            ${allParticipants.map(p => `<option value="${p.codigo}" data-row-index="${p.rowIndex}" data-tutora-id="${p.tutoraID}">${p.nombreCompleto} (${p.codigo})</option>`).join('')}
                        </select>
                        
                        <div id="participante-info" class="mt-4 p-4 border rounded-md bg-gray-50 hidden">
                            <p class="text-sm font-semibold">Código: <span id="info-codigo" class="font-normal"></span> | Tutora: <span id="info-tutora" class="font-normal"></span></p>
                            <p class="text-sm font-semibold text-blue-600">Último Pago: <span id="info-ultimo-pago" class="font-normal"></span></p>
                            <p class="text-sm font-semibold text-green-600">ABONO A FAVOR: $<span id="info-abono" class="font-normal">0</span></p>
                            <button onclick="copyParentURL()" class="mt-2 text-xs text-blue-500 hover:text-blue-700">Generar/Copiar URL de Padre</button>
                        </div>

                        <form id="registro-aporte-form" onsubmit="handleRegistrarAporte(event)" class="mt-4 hidden">
                            <h4 class="font-bold my-3 text-lg">Meses Pendientes:</h4>
                            <div id="meses-pendientes-list" class="space-y-2 max-h-40 overflow-y-auto p-2 border rounded-md"></div>

                            <div class="mt-4 pt-4 border-t">
                                <p class="text-lg font-bold text-red-600">DEUDA NETA (Aplicando Abono): $<span id="deuda-neta-display">0</span></p>
                                <p class="text-lg font-bold text-gray-800">TOTAL A PAGAR (Calculado): $<span id="total-calculado-display">0</span></p>
                                
                                <label for="monto-dado" class="block text-sm font-medium text-gray-700 mt-4">Monto Entregado ($):</label>
                                <input type="number" id="monto-dado" required min="0" oninput="updateAbonoDisplay()" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                
                                <div class="mt-4 p-3 bg-yellow-100 rounded-md">
                                    <p class="text-sm font-semibold">Nuevo Abono a Favor:</p>
                                    <p class="text-xl font-bold text-green-700">$<span id="nuevo-abono-display">0</span></p>
                                </div>
                                
                                <button type="submit" class="w-full mt-4 py-2 px-4 rounded-md shadow-sm text-sm font-medium text-white bg-blue-500 hover:bg-blue-600">
                                    Confirmar y Registrar Aporte
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="lg:col-span-2 space-y-6">
                        <div id="cuadro-historico" class="bg-white p-6 rounded-lg shadow hidden"></div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-xl font-semibold mb-4">Tabla de Aportes (Total)</h3>
                            ${renderAportesTable(allAportes)}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('monto-dado').addEventListener('input', updateAbonoDisplay);
        }
        
        function loadParticipanteInfo() {
            const select = document.getElementById('select-participante');
            const codigo = select.value;
            const p = allParticipants.find(p => p.codigo === codigo);
            const infoContainer = document.getElementById('participante-info');
            const formContainer = document.getElementById('registro-aporte-form');
            const cuadroContainer = document.getElementById('cuadro-historico');
            
            if (!codigo) { infoContainer.classList.add('hidden'); formContainer.classList.add('hidden'); cuadroContainer.classList.add('hidden'); return; }

            document.getElementById('info-codigo').textContent = p.codigo;
            document.getElementById('info-tutora').textContent = p.tutoraID;
            document.getElementById('info-abono').textContent = p.abono.toLocaleString('es-CO');
            document.getElementById('info-ultimo-pago').textContent = p.estadoAportes.ultimoMesPago;
            
            infoContainer.classList.remove('hidden');
            formContainer.classList.remove('hidden');
            cuadroContainer.classList.remove('hidden');

            renderMesesPendientes(p);
            cuadroContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">Estado de Pagos Anual</h3>${renderCuadroHistorico(p)}`;
            updateAporteCalculation();
        }

        function renderMesesPendientes(participante) {
            const listContainer = document.getElementById('meses-pendientes-list');
            listContainer.innerHTML = '';
            
            // Renderizar meses pagados (bloqueados) y pendientes (activos)
            let html = participante.estadoAportes.mesesPagados.map(mesAnio => `
                <div class="flex items-center">
                    <input type="checkbox" value="${mesAnio}" disabled checked class="h-4 w-4 text-primary border-gray-300 rounded bg-gray-200">
                    <label class="ml-3 text-sm font-medium text-gray-500 line-through">${mesAnio} (PAGADO)</label>
                </div>`).join('');

            html += participante.estadoAportes.mesesPendientes.map(item => `
                <div class="flex items-center">
                    <input type="checkbox" value="${item.mesAnio}" data-valor="${item.valor}" onchange="updateAporteCalculation()" class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                    <label class="ml-3 text-sm font-medium text-gray-900">${item.mesAnio} ($${item.valor.toLocaleString('es-CO')})</label>
                </div>`).join('');
            
            listContainer.innerHTML = html;
        }

        function updateAporteCalculation() {
            const checkboxes = document.querySelectorAll('#meses-pendientes-list input[type="checkbox"]:checked:not(:disabled)');
            let totalCalculado = 0;
            checkboxes.forEach(cb => { totalCalculado += parseInt(cb.dataset.valor); });
            
            const codigo = document.getElementById('select-participante').value;
            const p = allParticipants.find(p => p.codigo === codigo);
            const abonoAnterior = p ? p.abono : 0;

            const deudaNeta = Math.max(0, totalCalculado - abonoAnterior);

            document.getElementById('total-calculado-display').textContent = totalCalculado.toLocaleString('es-CO');
            document.getElementById('deuda-neta-display').textContent = deudaNeta.toLocaleString('es-CO');
            updateAbonoDisplay(); // Actualiza el cálculo del abono con el nuevo total
        }

        function updateAbonoDisplay() {
            const totalCalculado = parseFloat(document.getElementById('total-calculado-display').textContent.replace(/\$|,/g, '')) || 0;
            const montoDado = parseFloat(document.getElementById('monto-dado').value) || 0;
            
            const codigo = document.getElementById('select-participante').value;
            const p = allParticipants.find(p => p.codigo === codigo);
            const abonoAnterior = p ? p.abono : 0;
            
            const deudaNeta = totalCalculado - abonoAnterior;
            const nuevoAbono = Math.max(0, montoDado - deudaNeta);
            
            document.getElementById('nuevo-abono-display').textContent = nuevoAbono.toLocaleString('es-CO');
        }

        async function handleRegistrarAporte(event) {
            event.preventDefault();
            const select = document.getElementById('select-participante');
            const codigo = select.value;
            const p = allParticipants.find(p => p.codigo === codigo);
            
            const mesesSeleccionados = Array.from(document.querySelectorAll('#meses-pendientes-list input[type="checkbox"]:checked:not(:disabled)')).map(cb => cb.value);
            if (mesesSeleccionados.length === 0) { showMessage('aporte-message', 'Debe seleccionar al menos un mes a pagar.', 'error'); return; }

            const montoDado = parseFloat(document.getElementById('monto-dado').value);
            const totalCalculado = parseFloat(document.getElementById('total-calculado-display').textContent.replace(/\$|,/g, ''));
            const abonoAnterior = p.abono;

            if (montoDado <= 0) { showMessage('aporte-message', 'El monto dado debe ser positivo.', 'error'); return; }
            if (montoDado < (totalCalculado - abonoAnterior) && !confirm(`El monto dado ($${montoDado.toLocaleString('es-CO')}) es menor a la deuda neta ($${(totalCalculado - abonoAnterior).toLocaleString('es-CO')}). ¿Confirmar registro?`)) { return; }

            try {
                const result = await sendToAppsScript({
                    action: 'registrarAporte', participanteID: codigo, mesesSeleccionados, montoDado, totalCalculado, abonoAnterior, rowIndex: p.rowIndex,
                });

                showMessage('aporte-message', `Aporte registrado. Nuevo Abono: $${result.nuevoAbono.toLocaleString('es-CO')}.`, 'success');
                document.getElementById('registro-aporte-form').reset();
                loadParticipanteInfo();
            } catch (error) {
                showMessage('aporte-message', `Error al registrar: ${error.message}`, 'error');
            }
        }
        
        function renderCuadroHistorico(participante) {
            const pagos = participante.estadoAportes.mesesPagados;
            const currentYear = new Date().getFullYear();
            const years = Array.from({ length: currentYear - 2022 + 1 }, (_, i) => 2022 + i);
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            
            let html = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-center"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Año</th>${months.map(m => `<th class="px-3 py-2 text-xs font-medium text-gray-500 uppercase tracking-wider">${m}</th>`).join('')}</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            
            years.forEach(year => {
                html += `<tr><td class="px-3 py-2 text-sm font-semibold">${year}</td>`;
                months.forEach((month, index) => {
                    const mesAnio = `${(index + 1).toString().padStart(2, '0')}/${year}`;
                    const icon = pagos.includes(mesAnio) ? '<span class="text-green-500 font-bold">&#10003;</span>' : '<span class="text-red-500 font-bold">&#10006;</span>';
                    html += `<td class="px-3 py-2 whitespace-nowrap text-sm">${icon}</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table></div>`;
            return html;
        }

        async function renderActividad(container) {
            if (userData.rol !== ROL_ADMIN) { container.innerHTML = `<p class="text-lg text-red-500">Acceso Denegado.</p>`; return; }
            try {
                const actividad = await sendToAppsScript({ action: 'obtenerActividad' });
                
                container.innerHTML = `
                    <button onclick="handleBorrarActividad(null)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded mb-4">Borrar TODO el Registro</button>
                    <div id="actividad-message" class="mb-4"></div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-xl font-semibold mb-4">Registro de Actividad</h3>
                        ${renderActividadTable(actividad)}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<p class="text-lg text-red-500">Error al cargar actividad: ${error.message}</p>`;
            }
        }
        
        function renderActividadTable(actividad) {
            return `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha/Hora</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalle</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${actividad.map(a => `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(a.timestamp).toLocaleString('es-CO')}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${a.usuario}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${a.accion}</td><td class="px-6 py-4 text-sm text-gray-500">${a.detalle}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button onclick="handleBorrarActividad(${a.rowIndex})" class="text-red-600 hover:text-red-900">Borrar</button></td></tr>`).join('')}</tbody></table></div>`;
        }
        
        async function handleBorrarActividad(rowIndex) {
            if (!confirm(rowIndex ? '¿Está seguro de borrar esta fila de actividad?' : '⚠️ ¡ADVERTENCIA! ¿Está seguro de borrar TODO el registro de actividad?')) return;
            try {
                const result = await sendToAppsScript({ action: 'borrarActividad', rowIndex: rowIndex });
                showMessage('actividad-message', result.message, 'success');
                renderModule('actividad');
            } catch (error) { showMessage('actividad-message', `Error al borrar: ${error.message}`, 'error'); }
        }

        function copyParentURL() {
            const codigo = document.getElementById('select-participante').value;
            const p = allParticipants.find(p => p.codigo === codigo);
            if (!p || !p.tokenURL) { showMessage('aporte-message', 'Participante no seleccionado o Token no generado.', 'error'); return; }

            const parentURL = `${APPS_SCRIPT_URL}?view=parent&token=${p.tokenURL}`;
            navigator.clipboard.writeText(parentURL)
                .then(() => showMessage('aporte-message', 'URL del Padre copiada al portapapeles.', 'success'))
                .catch(() => showMessage('aporte-message', 'Error al copiar la URL. Intente de nuevo.', 'error'));
        }

        // --- AUTENTICACIÓN Y ENRUTAMIENTO ---

        async function handleLogin(event) {
            event.preventDefault();
            const user = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const result = await sendToAppsScript({ action: 'login', user, password }, 'NO_TOKEN');
                
                userData = result;
                document.getElementById('user-display').textContent = userData.usuario;

                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');

                if (userData.rol !== ROL_ADMIN) {
                    document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                    document.getElementById('sidebar').classList.remove('w-64');
                    document.getElementById('sidebar').classList.add('w-20');
                } else {
                    document.getElementById('sidebar').classList.remove('w-20');
                    document.getElementById('sidebar').classList.add('w-64');
                }

                await loadData(true);
                setupAutoRefresh();
                
                const startModule = userData.rol === ROL_ADMIN ? 'dashboard' : 'aportes';
                renderModule(startModule);

            } catch (error) {
                showMessage('login-message', error.message, 'error');
            }
        }

        function logout() {
            clearInterval(refreshTimer);
            userData = {};
            document.getElementById('login-form').reset();
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            showMessage('login-message', 'Sesión cerrada con éxito.', 'success');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.querySelectorAll('#sidebar a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    renderModule(e.target.dataset.module);
                });
            });
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            hideLoader();
        });
    </script>
</body>
</html>
