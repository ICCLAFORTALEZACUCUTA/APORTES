<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Aportes | ICC</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí∞</text></svg>" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <style>
        /* ========================================================= */
        /* CSS STYLES - DISE√ëO PROFESIONAL Y RESPONSIVO */
        /* ========================================================= */

        :root {
            --color-primario: #0891b2;
            /* Cyan 700 */
            --color-primario-dark: #0e7490;
            /* Cyan 800 */
            --color-secundario: #10b981;
            /* Emerald 500 (√âxito) */
            --color-error: #ef4444;
            /* Red 500 */
            --color-fondo: #f0f9ff;
            /* Fondo muy claro */
            --color-card: #ffffff;
            --color-texto: #333333;
            --color-borde: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* --- Estructura Global --- */
        #login-view {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--color-primario-dark);
        }

        #app-container {
            display: none;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        /* --- Navegaci√≥n Lateral (Sidebar) --- */
        #sidebar {
            background-color: var(--color-primario);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        #sidebar h2 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .nav-item i {
            margin-right: 10px;
            font-size: 1.1em;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: var(--color-primario-dark);
            border-left: 5px solid var(--color-secundario);
            padding-left: 15px;
        }

        #logout {
            position: absolute;
            bottom: 20px;
            width: 250px;
            text-align: center;
            color: #ffcccc;
        }

        /* --- Contenido Principal (Main Content) --- */
        #main-content {
            padding: 30px;
            overflow-y: auto;
        }

        .module-view {
            display: none;
        }

        .module-view.active {
            display: block;
        }

        /* --- Tarjetas y Dise√±o --- */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--color-card);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card h3 {
            color: var(--color-primario-dark);
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .card .value {
            font-size: 2em;
            font-weight: 700;
            color: var(--color-secundario);
        }

        .card-info {
            padding: 15px;
            background-color: var(--color-fondo);
            border-radius: 4px;
            border-left: 4px solid var(--color-primario);
            margin-top: 15px;
        }

        /* --- Tablas --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9em;
        }

        th,
        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-borde);
            text-align: left;
        }

        th {
            background-color: var(--color-primario-dark);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
        }

        tbody tr:hover {
            background-color: #f0f0f0;
        }

        .tag-activo {
            color: #16a34a;
            font-weight: 600;
        }

        .tag-inactivo {
            color: var(--color-error);
            font-weight: 600;
        }

        .btn-url {
            background-color: var(--color-secundario);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .btn-url:hover {
            background-color: #059669;
        }

        /* --- Formularios y Controles --- */
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 10px;
            border: 1px solid var(--color-borde);
            border-radius: 6px;
            width: 100%;
            max-width: 300px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--color-primario);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primario-dark);
        }

        .btn-secondary {
            background-color: #94a3b8;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #64748b;
        }

        /* --- Modal (Registro de Aportes) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
        }

        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--color-card);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--color-error);
        }

        .meses-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .mes-item {
            padding: 10px;
            border: 1px solid var(--color-borde);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 0.85em;
        }

        .mes-pagado {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #10b981;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .mes-seleccionado {
            background-color: var(--color-primario);
            color: white;
            border-color: var(--color-primario-dark);
        }

        .mes-deuda {
            background-color: #fee2e2;
            color: var(--color-error);
            border-color: var(--color-error);
        }

        /* --- Responsive Design (Mobile First) --- */
        @media (max-width: 768px) {
            #app-container {
                grid-template-columns: 1fr;
            }

            #sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 10px 0;
            }

            #sidebar h2 {
                display: none;
            }

            .nav-item {
                display: inline-flex;
                width: 33.33%;
                text-align: center;
                justify-content: center;
                padding: 10px 5px;
                border-left: none !important;
            }

            .nav-item span {
                display: none;
            }

            .nav-item i {
                margin-right: 0;
            }

            #logout {
                display: none;
            }

            #main-content {
                padding: 15px;
            }

            .meses-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>

<body>

    <div id="login-view">
        <div class="card" style="max-width: 400px; text-align: center;">
            <h2>Bienvenido | ICC</h2>
            <form id="login-form">
                <div style="margin-bottom: 15px;">
                    <input type="text" id="username" placeholder="Usuario" required style="max-width: 100%;" />
                </div>
                <div style="margin-bottom: 25px;">
                    <input type="password" id="password" placeholder="Contrase√±a" required style="max-width: 100%;" />
                </div>
                <button type="submit" class="btn-primary" id="login-btn" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
                </button>
                <p id="login-message" style="color: var(--color-error); margin-top: 15px;"></p>
            </form>
        </div>
    </div>

    <div id="app-container">

        <aside id="sidebar">
            <h2>ICC Gestor</h2>
            <div id="nav-list">
                <div class="nav-item active" data-module="dashboard" data-roles="ADMIN,TUTORA">
                    <i class="fas fa-chart-line"></i> <span>Dashboard</span>
                </div>
                <div class="nav-item" data-module="participantes-aportes" data-roles="ADMIN,TUTORA">
                    <i class="fas fa-users"></i> <span>Participantes</span>
                </div>
                <div class="nav-item" data-module="registro-actividad" data-roles="ADMIN">
                    <i class="fas fa-history"></i> <span>Actividad</span>
                </div>
            </div>
            <div id="logout">
                <p id="user-info" style="margin-bottom: 10px; font-size: 0.9em;"></p>
                <div class="nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesi√≥n</span>
                </div>
            </div>
        </aside>

        <main id="main-content">
            <section id="dashboard" class="module-view active">
                <h1 style="color: var(--color-primario-dark); margin-bottom: 20px;">
                    <i class="fas fa-tachometer-alt"></i> Dashboard General
                </h1>

                <div id="admin-stats" class="grid-3" style="display: none;">
                    <div class="card">
                        <h3><i class="fas fa-dollar-sign"></i> Total Recibido (ACUM.)</h3>
                        <p class="value" id="stat-total-recibido">...</p>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-hand-holding-usd"></i> Media por Aporte</h3>
                        <p class="value" id="stat-media-aporte">...</p>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-users"></i> Participantes Activos</h3>
                        <p class="value" id="stat-participantes-activos">...</p>
                    </div>
                </div>

                <div id="admin-charts" class="grid-3" style="display: none;">
                    <div class="card" style="grid-column: span 2;">
                        <h3><i class="fas fa-chart-bar"></i> Aportes Recibidos por Mes y A√±o</h3>
                        <canvas id="aportesChart" height="120"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fas fa-list-alt"></i> √öltimos 10 Aportes Registrados</h3>
                    <div class="card-info" id="ultimos-aportes-list">
                        <p>Cargando √∫ltimos aportes...</p>
                    </div>
                </div>
            </section>

            <section id="participantes-aportes" class="module-view">
                <h1 style="color: var(--color-primario-dark); margin-bottom: 20px;">
                    <i class="fas fa-users"></i> Gesti√≥n de Participantes y Aportes
                </h1>

                <div class="controls">
                    <input type="text" id="participantes-search" placeholder="Buscar por Nombre o C√≥digo"
                        onkeyup="filterParticipantes()" />
                    <button class="btn-primary" id="btn-nuevo-participante" onclick="alert('Funcionalidad CRUD pendiente.')" style="display: none;">
                        <i class="fas fa-plus"></i> Nuevo Participante
                    </button>
                </div>

                <div class="card">
                    <h3><i class="fas fa-table"></i> Listado de Participantes</h3>
                    <table id="participantes-table">
                        <thead>
                            <tr>
                                <th>C√≥d.</th>
                                <th>Nombre</th>
                                <th>Tutora</th>
                                <th>Estado</th>
                                <th>√öltimo Pago</th>
                                <th>Meses Deuda</th>
                                <th>Total Deuda</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="participantes-tbody">
                            <tr>
                                <td colspan="8">Cargando participantes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="registro-actividad" class="module-view">
                <h1 style="color: var(--color-primario-dark); margin-bottom: 20px;">
                    <i class="fas fa-history"></i> Registro de Actividad
                </h1>

                <div class="controls">
                    <button class="btn-secondary" onclick="fetchActividad()"><i class="fas fa-sync"></i> Actualizar
                        Actividad</button>
                    <button class="btn-primary" onclick="borrarActividad(null)"><i class="fas fa-trash"></i>
                        Borrar Todo (ADMIN)</button>
                </div>

                <div class="card">
                    <h3><i class="fas fa-list-ul"></i> Historial de Transacciones y Errores</h3>
                    <table id="actividad-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Usuario</th>
                                <th>Acci√≥n</th>
                                <th>Detalle</th>
                                <th>...</th>
                            </tr>
                        </thead>
                        <tbody id="actividad-tbody">
                            <tr>
                                <td colspan="5">Cargando actividad...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <div id="aporte-modal-overlay" class="modal-overlay">
            <form id="aporte-form" class="modal-content">
                <span class="close-btn" onclick="closeAporteModal()">&times;</span>
                <h2 id="modal-title-aporte" style="color: var(--color-primario);">Registrar Aporte</h2>

                <div id="participante-details" class="card-info">
                    <p><strong>C√≥d.:</strong> <span id="reg-codigo"></span> | 
                    <strong>Nombre:</strong> <span id="reg-nombre"></span></p>
                    <p><strong>Tutora:</strong> <span id="reg-tutora"></span> | 
                    <strong>√öltimo Pago:</strong> <span id="reg-ultimo-pago"></span></p>
                    <p style="margin-top: 10px;">
                        <strong>Abono a Favor:</strong> <span id="reg-abono" class="tag-activo"></span> | 
                        <strong>Deuda Neta:</strong> <span id="reg-deuda-total" class="tag-inactivo"></span>
                    </p>
                </div>

                <h3>1. Seleccionar Meses a Pagar</h3>
                <p style="font-size: 0.9em; margin-bottom: 10px;">
                    Clic en los meses con ‚ùå para seleccionarlos. ‚úÖ ya est√°n pagos.
                </p>
                <div class="meses-grid" id="meses-grid-container">
                    </div>

                <h3>2. Resumen y Monto Recibido</h3>
                <div class="card-info" style="background-color: #d1fae5; border-left-color: var(--color-secundario);">
                    <p>Meses Seleccionados: <strong id="res-conteo">0</strong></p>
                    <p>Valor Total a Cubrir: <strong id="res-total-calculado" style="color: var(--color-primario-dark);"> $0</strong></p>
                </div>
                
                <div style="margin-top: 15px;">
                    <label for="monto-dado" style="display: block; font-weight: 600;">Monto Recibido del Padre:</label>
                    <input type="number" id="monto-dado" placeholder="Ej: 5000" min="0" required 
                           style="max-width: 100%; margin-top: 5px;" oninput="updateMontoDado()">
                </div>

                <div class="card-info" style="margin-top: 15px;">
                    <p>Nuevo Abono Restante: <strong id="res-nuevo-abono" style="color: var(--color-secundario);"> $0</strong></p>
                    <p style="font-size: 0.8em; margin-top: 5px; color: #666;">
                        (Monto dado - Deuda neta). Se actualizar√° en la hoja.
                    </p>
                </div>

                <div style="margin-top: 30px; text-align: right;">
                    <button type="submit" class="btn-primary" id="btn-registrar">
                        <i class="fas fa-check-circle"></i> Registrar Aporte
                    </button>
                    <button type="button" class="btn-secondary" onclick="closeAporteModal()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>

    </div>

    <script>
        // =========================================================
        // JAVASCRIPT CORE
        // =========================================================

        // ‚ö†Ô∏è REEMPLAZAR con la URL de implementaci√≥n de tu Apps Script (termina en /exec)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwI5mA0fHhXuHtJXZfDaKTCpxH8Cmhf6qrTuPEthFvz7vMcIWmv94uO53TtrFktrKHN/exec';

const $ = id => document.getElementById(id);

        let APP_DATA = {
            token: localStorage.getItem('sessionToken'),
            rol: localStorage.getItem('userRol'),
            tutoraID: localStorage.getItem('tutoraID'),
            usuario: localStorage.getItem('usuario'),
            participantes: [],
            ultimosAportes: [],
            actividad: [],
            estadisticas: {}
        };
        let currentModule = 'dashboard';
        let participantesOriginal = [];
        let participantesFiltrados = [];
        let myChart = null; // Variable para la instancia de Chart.js

        // --- Utilidades ---
        const formatMoney = amount => `$${Number(amount).toLocaleString('es-CO')}`;
        const getCurrentDate = () => new Date().toISOString().slice(0, 10);

        // --- Core de Conexi√≥n ---
        async function sendToAppsScript(action, payload) {
            const dataToSend = { ...payload, action: action, token: APP_DATA.token };

            try {
                // Apps Script requiere el Content-Type como text/plain para un POST simple
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                return result.data;

            } catch (error) {
                console.error('Error en sendToAppsScript:', error);
                alert(`Error: ${error.message}`);
                // Si el error es de sesi√≥n/token, forzar logout
                if (error.message.includes('Sesi√≥n expirada') || error.message.includes('token inv√°lido')) {
                    logout();
                }
                throw error;
            }
        }

        // =========================================================
        // 1. L√ìGICA DE LOGIN Y SESI√ìN
        // =========================================================

        function init() {
            if (APP_DATA.token && APP_DATA.rol) {
                // Si hay token, intentar cargar los datos
                showApp();
                fetchInitialData();
            } else {
                // Si no hay token, mostrar login
                showLogin();
            }
        }

        function showLogin() {
            $('login-view').style.display = 'flex';
            $('app-container').style.display = 'none';
        }

        function showApp() {
            $('login-view').style.display = 'none';
            $('app-container').style.display = 'grid';

            // Mostrar info de usuario en el sidebar
            $('user-info').innerHTML = `Logueado como: <strong>${APP_DATA.usuario}</strong> (${APP_DATA.rol})`;

            // Filtrar m√≥dulos por rol
            document.querySelectorAll('.nav-item').forEach(item => {
                const requiredRoles = item.getAttribute('data-roles').split(',');
                if (requiredRoles.includes(APP_DATA.rol)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // Mostrar/Ocultar controles de ADMIN
            if (APP_DATA.rol === 'ADMIN') {
                $('btn-nuevo-participante').style.display = 'inline-block';
            }
        }

        $('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = $('username').value;
            const password = $('password').value;
            $('login-btn').disabled = true;
            $('login-message').innerText = 'Iniciando sesi√≥n...';

            try {
                const result = await sendToAppsScript('login', { user, password });
                
                // Guardar sesi√≥n
                APP_DATA.token = result.token;
                APP_DATA.rol = result.rol;
                APP_DATA.tutoraID = result.tutoraID;
                APP_DATA.usuario = result.usuario;
                localStorage.setItem('sessionToken', result.token);
                localStorage.setItem('userRol', result.rol);
                localStorage.setItem('tutoraID', result.tutoraID);
                localStorage.setItem('usuario', result.usuario);

                $('login-message').innerText = '';
                showApp();
                fetchInitialData();

            } catch (error) {
                $('login-message').innerText = 'Error de credenciales.';
                console.error('Login failed:', error);
            } finally {
                $('login-btn').disabled = false;
            }
        });

        function logout() {
            localStorage.clear();
            APP_DATA.token = null;
            APP_DATA.rol = null;
            APP_DATA.tutoraID = null;
            APP_DATA.usuario = null;
            showLogin();
            // Limpiar datos de la aplicaci√≥n
            APP_DATA.participantes = [];
            APP_DATA.ultimosAportes = [];
            APP_DATA.actividad = [];
        }


        // =========================================================
        // 2. L√ìGICA DE DATOS Y RENDERIZADO
        // =========================================================

        async function fetchInitialData() {
            try {
                const result = await sendToAppsScript('obtenerDatosIniciales', { 
                    rol: APP_DATA.rol, 
                    tutoraID: APP_DATA.tutoraID 
                });

                APP_DATA.participantes = result.participantes;
                participantesOriginal = result.participantes;
                participantesFiltrados = result.participantes; // Inicialmente, todos
                APP_DATA.ultimosAportes = result.ultimosAportes;
                APP_DATA.estadisticas = result.estadisticas;

                // Renderizar la vista activa (por defecto dashboard)
                switchModule(currentModule);

            } catch (error) {
                console.error('Error al cargar datos iniciales:', error);
                alert('No se pudieron cargar los datos iniciales. Revisar consola o sesi√≥n.');
            }
        }

        // --- Renderizado General ---
        function switchModule(moduleName) {
            currentModule = moduleName;
            
            // Ocultar todas las vistas
            document.querySelectorAll('.module-view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Mostrar la vista y el √≠tem de navegaci√≥n activo
            $(moduleName).classList.add('active');
            document.querySelector(`.nav-item[data-module="${moduleName}"]`).classList.add('active');

            // Llamar a la funci√≥n de renderizado espec√≠fica
            if (moduleName === 'dashboard') renderDashboard();
            if (moduleName === 'participantes-aportes') renderParticipantesTable();
            if (moduleName === 'registro-actividad') fetchActividad(); // Siempre cargar la actividad al entrar
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                switchModule(item.getAttribute('data-module'));
            });
        });

        // =========================================================
        // 2.1. DASHBOARD
        // =========================================================
        function renderDashboard() {
            // Renderizar Estad√≠sticas (Solo ADMIN)
            if (APP_DATA.rol === 'ADMIN') {
                $('admin-stats').style.display = 'grid';
                $('admin-charts').style.display = 'grid';

                const totalRecibido = APP_DATA.estadisticas.totalRecibido || 0;
                const mediaAporte = APP_DATA.estadisticas.mediaAporte || 0;
                const activos = APP_DATA.participantes.filter(p => p.estado === 'ACTIVO').length;

                $('stat-total-recibido').innerText = formatMoney(totalRecibido);
                $('stat-media-aporte').innerText = formatMoney(mediaAporte);
                $('stat-participantes-activos').innerText = activos;
                
                renderAportesChart(APP_DATA.estadisticas.aportesPorMesAnio);

            } else {
                $('admin-stats').style.display = 'none';
                $('admin-charts').style.display = 'none';
            }

            // Renderizar √öltimos Aportes
            const ul = $('ultimos-aportes-list');
            ul.innerHTML = APP_DATA.ultimosAportes.map(aporte => {
                return `<p>
                            <i class="fas fa-arrow-circle-right"></i> 
                            ${formatMoney(aporte.montoPagado)} para ${aporte.codigoParticipante} (Cubre: ${aporte.mesCubierto}) - ${new Date(aporte.fechaRegistro).toLocaleDateString()}
                        </p>`;
            }).join('');
        }

        function renderAportesChart(data) {
            const ctx = $('aportesChart').getContext('2d');
            if (myChart) myChart.destroy();

            // Preparar datos (Ordenar por AAAA/MM)
            const sortedKeys = Object.keys(data).sort();
            const labels = sortedKeys.map(key => {
                const [anio, mes] = key.split('/');
                return `${mes}/${anio}`;
            });
            const amounts = sortedKeys.map(key => data[key]);

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monto Recibido',
                        data: amounts,
                        backgroundColor: '#10b981', // var(--color-secundario)
                        borderColor: '#34d399', // var(--color-secundario-light)
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Monto (COP)' },
                            ticks: { callback: (value) => formatMoney(value) }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => formatMoney(value),
                            color: '#333333' // var(--color-texto)
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }


        // =========================================================
        // 2.2. PARTICIPANTES Y APORTES
        // =========================================================

        function filterParticipantes() {
            const query = $('participantes-search').value.toLowerCase();
            participantesFiltrados = participantesOriginal.filter(p =>
                p.nombreCompleto.toLowerCase().includes(query) ||
                p.codigo.toLowerCase().includes(query)
            );
            renderParticipantesTable();
        }

        function renderParticipantesTable() {
            const tbody = $('participantes-tbody');
            tbody.innerHTML = participantesFiltrados.map(p => {
                const estadoClase = p.estado === 'ACTIVO' ? 'tag-activo' : 'tag-inactivo';
                const deudaNeta = Math.max(0, p.estadoAportes.deudaTotal - p.abono);

                return `
                    <tr>
                        <td>${p.codigo}</td>
                        <td>${p.nombreCompleto}</td>
                        <td>${p.tutoraID}</td>
                        <td class="${estadoClase}">${p.estado}</td>
                        <td>${p.estadoAportes.ultimoMesPago}</td>
                        <td>${p.estadoAportes.mesesPendientes.length}</td>
                        <td>${formatMoney(deudaNeta)}</td>
                        <td>
                            <button class="btn-primary" onclick="openAporteModal('${p.codigo}')">
                                <i class="fas fa-cash-register"></i> Pagar
                            </button>
                            <button class="btn-url" onclick="copyURL('${p.tokenURL}')">
                                <i class="fas fa-link"></i> URL
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function copyURL(token) {
            const fullUrl = APPS_SCRIPT_URL + `?view=parent&token=${token}`;
            navigator.clipboard.writeText(fullUrl).then(() => {
                alert(`URL copiada al portapapeles: ${fullUrl}`);
            }).catch(err => {
                console.error('Error al copiar: ', err);
                alert('Error al copiar URL. Revisa la consola.');
            });
        }


        // --- L√≥gica del Modal de Registro de Aportes ---

        let currentParticipante = null;

        function openAporteModal(codigo) {
            currentParticipante = participantesOriginal.find(p => p.codigo === codigo);

            if (!currentParticipante) {
                alert('Error: Participante no encontrado.');
                return;
            }

            // Datos generales
            $('reg-codigo').innerText = currentParticipante.codigo;
            $('reg-nombre').innerText = currentParticipante.nombreCompleto;
            $('reg-tutora').innerText = currentParticipante.tutoraID;
            $('reg-ultimo-pago').innerText = currentParticipante.estadoAportes.ultimoMesPago;
            $('reg-abono').innerText = formatMoney(currentParticipante.abono);

            const deudaNeta = Math.max(0, currentParticipante.estadoAportes.deudaTotal - currentParticipante.abono);
            $('reg-deuda-total').innerText = formatMoney(deudaNeta);

            // Renderizar la grilla de meses
            renderMesesGrid(currentParticipante.estadoAportes.mesesHistoricos);
            
            // Resetear y mostrar modal
            $('aporte-form').reset();
            $('monto-dado').value = 0;
            updateAporteSummary();
            $('aporte-modal-overlay').classList.add('visible');
        }

        function closeAporteModal() {
            currentParticipante = null;
            $('aporte-modal-overlay').classList.remove('visible');
        }
        
        // Al enviar el formulario de registro de aporte
        $('aporte-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const montoDado = Number($('monto-dado').value);
            const mesesSeleccionados = Array.from(document.querySelectorAll('.mes-seleccionado')).map(el => el.dataset.mes);
            const totalCalculado = mesesSeleccionados.reduce((sum, mes) => {
                const { valor } = currentParticipante.estadoAportes.mesesPendientes.find(m => m.mesAnio === mes) || { valor: 0 };
                return sum + valor;
            }, 0);

            if (mesesSeleccionados.length === 0) {
                alert('Debe seleccionar al menos un mes para registrar el aporte.');
                return;
            }
            if (montoDado < totalCalculado) {
                 if (!confirm(`El monto dado (${formatMoney(montoDado)}) es menor al valor de los meses seleccionados (${formatMoney(totalCalculado)}). ¬øDesea registrar este pago parcial?`)) {
                    return;
                }
            }


            $('btn-registrar').disabled = true;
            $('btn-registrar').innerHTML = `<i class="fas fa-spinner fa-spin"></i> Registrando...`;

            const payload = {
                participanteID: currentParticipante.codigo,
                mesesSeleccionados: mesesSeleccionados,
                montoDado: montoDado,
                totalCalculado: totalCalculado,
                abonoAnterior: currentParticipante.abono,
                registrador: APP_DATA.usuario,
                rowIndex: currentParticipante.rowIndex
            };

            try {
                await sendToAppsScript('registrarAporte', payload);
                alert('‚úÖ Aporte registrado con √©xito. Se notific√≥ por Telegram.');
                closeAporteModal();
                // Refrescar datos y tabla
                await fetchInitialData(); 
            } catch (error) {
                console.error('Fallo al registrar aporte:', error);
                alert('Fallo al registrar aporte. Ver consola.');
            } finally {
                $('btn-registrar').disabled = false;
                $('btn-registrar').innerHTML = `<i class="fas fa-check-circle"></i> Registrar Aporte`;
            }
        });

        // Grilla de Meses
        function renderMesesGrid(mesesHistoricos) {
            const container = $('meses-grid-container');
            container.innerHTML = ''; // Limpiar

            // Invertir para mostrar lo m√°s reciente primero
            mesesHistoricos.slice().reverse().forEach(mes => {
                const isPagado = mes.pagado;
                const mesAnio = mes.mesAnio;
                const valor = formatMoney(mes.valor);
                // Determinar si es deuda (pasado o presente)
                const isDeuda = !isPagado && new Date(`${mesAnio.split('/')[1]}-${mesAnio.split('/')[0]}-01T00:00:00Z`).getTime() < Date.now();
                
                const clase = isPagado ? 'mes-pagado' : isDeuda ? 'mes-deuda' : 'mes-item';
                const icon = isPagado ? '‚úÖ' : '‚ùå';

                const item = document.createElement('div');
                item.className = `mes-item ${clase}`;
                item.dataset.mes = mesAnio;
                item.dataset.valor = mes.valor;
                item.innerHTML = `${icon} ${mesAnio} (${valor})`;

                if (!isPagado) {
                    item.onclick = toggleMesSeleccionado;
                }
                container.appendChild(item);
            });
        }
        
        function toggleMesSeleccionado(event) {
            const item = event.currentTarget;
            item.classList.toggle('mes-seleccionado');
            updateAporteSummary();
        }

        function updateAporteSummary() {
            const mesesSeleccionados = document.querySelectorAll('.mes-seleccionado');
            let totalCalculado = 0;
            
            mesesSeleccionados.forEach(item => {
                totalCalculado += Number(item.dataset.valor);
            });

            const abonoAnterior = currentParticipante ? Number(currentParticipante.abono) : 0;
            const montoDado = Number($('monto-dado').value) || 0;
            const deudaNeta = Math.max(0, totalCalculado - abonoAnterior);
            const nuevoAbono = Math.max(0, montoDado - deudaNeta);
            
            $('res-conteo').innerText = mesesSeleccionados.length;
            $('res-total-calculado').innerText = formatMoney(totalCalculado);
            $('res-nuevo-abono').innerText = formatMoney(nuevoAbono);
        }

        function updateMontoDado() {
            // Se llama cada vez que el usuario escribe en el monto
            updateAporteSummary();
        }


        // =========================================================
        // 2.3. REGISTRO DE ACTIVIDAD
        // =========================================================

        async function fetchActividad() {
            if (APP_DATA.rol !== 'ADMIN') return;

            try {
                const result = await sendToAppsScript('obtenerActividad', {});
                APP_DATA.actividad = result;
                renderActividadTable();
            } catch (error) {
                console.error('Fallo al cargar actividad:', error);
            }
        }

        function renderActividadTable() {
            const tbody = $('actividad-tbody');
            tbody.innerHTML = APP_DATA.actividad.map(a => {
                const rowClase = a.accion.includes('ERROR') ? 'style="background-color: #fee2e2;"' : '';
                const timestamp = new Date(a.timestamp).toLocaleString('es-CO');
                
                return `
                    <tr ${rowClase}>
                        <td>${timestamp}</td>
                        <td>${a.usuario}</td>
                        <td><strong>${a.accion}</strong></td>
                        <td>${a.detalle}</td>
                        <td>
                            <button class="btn-secondary" onclick="borrarActividad(${a.rowIndex})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            if (APP_DATA.actividad.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5">No hay registros de actividad.</td></tr>`;
            }
        }

        async function borrarActividad(rowIndex) {
            if (APP_DATA.rol !== 'ADMIN') {
                alert('Permisos insuficientes.');
                return;
            }

            if (!confirm(rowIndex ? `¬øEst√° seguro de eliminar el registro en la fila ${rowIndex}?` : '¬øEst√° seguro de borrar TODO el registro de actividad?')) {
                return;
            }

            try {
                await sendToAppsScript('borrarActividad', { rowIndex: rowIndex, registrador: APP_DATA.usuario });
                alert('Borrado exitoso.');
                fetchActividad(); // Recargar la tabla
            } catch (error) {
                console.error('Error al borrar actividad:', error);
                alert('Fallo al borrar actividad. Ver consola.');
            }
        }


        // =========================================================
        // INICIO
        // =========================================================
        window.onload = init;
    </script>
</body>

</html>
